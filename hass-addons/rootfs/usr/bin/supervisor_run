#!/usr/bin/env bash

# shellcheck disable=SC1091
source /etc/supervisor/common
source /etc/container/arch.sh

echo "Run Supervisor"

start_systemd_journald
start_docker
trap "stop_docker" ERR

if [ "$( docker container inspect -f '{{.State.Status}}' hassio_supervisor )" == "running" ]; then
    echo "Restarting Supervisor"
    docker rm -f hassio_supervisor
    init_dbus
    init_udev
    init_os_agent
    cleanup_lastboot
    run_supervisor
    stop_docker

else
    echo "Starting Supervisor"
    docker system prune -f
    cleanup_lastboot
    cleanup_docker
    init_dbus
    init_udev
    init_os_agent
    run_supervisor
    stop_docker
fi
